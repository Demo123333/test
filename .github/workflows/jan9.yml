name: BMS Jan 8 Hourly Tracker

on:
  workflow_dispatch:
  schedule:
    # Every hour UTC (mapped to IST internally)
    - cron: "0 * * * *"

permissions:
  contents: write

jobs:
# =====================================================
# 0ï¸âƒ£ Date Gate â€“ ONLY Jan 8, 2026 (IST)
# =====================================================
  date-gate:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}

    steps:
      - name: Check Jan 8 window (IST)
        id: check
        run: |
          TODAY=$(TZ=Asia/Kolkata date +%Y-%m-%d)
          TARGET_DATE="2026-01-08"

          HOUR=$(TZ=Asia/Kolkata date +%H)

          echo "Today (IST): $TODAY"
          echo "Hour  (IST): $HOUR"

          if [[ "$TODAY" == "$TARGET_DATE" ]]; then
            echo "âœ… Jan 8 detected â†’ allowed"
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Not Jan 8 â†’ blocked"
            echo "allowed=false" >> $GITHUB_OUTPUT
          fi

# =====================================================
# 1ï¸âƒ£ Decide DATE_CODE (FIXED = Jan 8)
# =====================================================
  decide-day:
    needs: date-gate
    if: needs.date-gate.outputs.allowed == 'true'
    runs-on: ubuntu-latest

    outputs:
      days_ahead: ${{ steps.set.outputs.days_ahead }}
      date_code:  ${{ steps.set.outputs.date_code }}

    steps:
      - name: Freeze Jan 8 DATE_CODE
        id: set
        run: |
          DATE_CODE="20260108"
          DAYS_AHEAD=0

          echo "Running hourly for Jan 8, 2026"
          echo "DATE_CODE=$DATE_CODE"

          echo "days_ahead=$DAYS_AHEAD" >> $GITHUB_OUTPUT
          echo "date_code=$DATE_CODE"   >> $GITHUB_OUTPUT

# =====================================================
# 2ï¸âƒ£ Run ALL shards in parallel (Hourly)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    needs: decide-day
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install cloudscraper aiohttp pytz selenium webdriver-manager

      - name: ğŸš€ Run shard scraper
        run: |
          python bmsrotate${{ matrix.shard }}.py
        env:
          DAYS_AHEAD: ${{ needs.decide-day.outputs.days_ahead }}
          DATE_CODE:  ${{ needs.decide-day.outputs.date_code }}

      - name: ğŸ’¾ Commit shard output
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add advance/data/${{ needs.decide-day.outputs.date_code }}/
          git commit -m "Jan 8 hourly shard ${{ matrix.shard }}" || echo "No changes"
          for i in 1 2 3; do
            git pull --rebase origin main || true
            git push origin main && break
            sleep 3
          done

# =====================================================
# 3ï¸âƒ£ Combine shards (EVERY HOUR)
# =====================================================
  combine:
    needs: [decide-day, shards]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸ”„ Sync main
        run: |
          git fetch origin
          git reset --hard origin/main

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ”— Combine JSONs
        run: |
          python combine_shards_rotate.py
        env:
          DATE_CODE: ${{ needs.decide-day.outputs.date_code }}

      - name: ğŸ’¾ Commit final output
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add advance/data/${{ needs.decide-day.outputs.date_code }}/final*
          git commit -m "Jan 8 hourly final combine" || echo "No changes"
          for i in 1 2 3; do
            git pull --rebase origin main || true
            git push origin main && break
            sleep 3
          done
